###                                           Webcam Project Phase2

####  **Traffic Analysis **

In the previous stage, we obtained preliminary conclusions such as periodicity through the information provided to us by Wireshark and the rough analysis of data visualization. In order to further study the nature of the network webcam traffic, we analyze the collected data separately according to the protocol, currently mainly UDP and TCP. 

The first is feature engineering. We selected these features from the original data :

- Time: Time for each packet when we captured it
- IP_src: The source ip address
- IP_dst: The destination ip address
- IP_len: The length of IP field
- IP_id: The identification for the packet
- IP_ttl: Time to Live
- IP_chksum: The checksum of IP field
- sport: The source port
- dport: The destination port
- udp_len/tcp_len: The length of UDP/TCP field
- udp_chksum/tcp_chksum: The checksum of UDP/TCP field

These features include useful information for our project. The main idea for our project is to train different models for different types of packets, which are sent for different usage. 



**Using Statistic method**

For statistical part of our project, we plan to calculate p-values for selected features, and use techniques for combining p-values to estimate the anomaly of each packet.

Properties for each feature and the distribution:

   - Time: Continuous variable. This feature increases as index grows, and the interval for every consecutive packets obeys a law. We have not found out this law yet, but I guess it is a sum of several Gauss distributions with very small std, which means the activity of the packets is the sum of several periodic activities. (This assumption has not been discussed yet.)

   - IP_src, IP_dst: We are only interested in packets that are sent to our webcams, thus IP_dst is used to filter out webcam traffic. For IP_src, we think the usage for each packet can be determined by IP_src and sport to some extent. Thus we plan to build different models for each IP_src.

     **Once IP_src is fixed, the usage for packets will be restricted to a finite set of situations. For a fixed usage, the following features will be determined.**

   - IP_len, IP_ttl, udp_len/tcp_len

     **The following features infer information of the packets. We guess they obey mixed Gaussian distribution.**

   - ip_chksum, udp_chksum/tcp_chksum: It is a linear hash function of IP filed/UDP/TCP field. For a determined usage, the data of packets will be relevantly stable. (If a packet is used to change password, the only difference between two packets will be the different password.) Since the checksum is a linear function of packet data, it will be stable too.  

     Checksum is a 16-bit {0,1} sequence, and then calculate it as an integer. First we think the checksum will obey mixed Gaussian distribution, and it performs well for most of ip_src (shown in the figure).

     ![image-20200805222043427](C:\Users\Cauch\AppData\Roaming\Typora\typora-user-images\image-20200805222043427.png)

     But it does not work for ip addresses from AliCloud. 

     ![image-20200805222246404](C:\Users\Cauch\AppData\Roaming\Typora\typora-user-images\image-20200805222246404.png)

     After days of discussion, we think it is because the 16 bits of checksum should be equally treated, but the checksum just calculate it as a binary integer, and this makes some of the bits contribute far more than other bits.

     Also, we come up with solutions for this problem.

     1. Try to find another hash function, which loses as little information as possible, but treats each bit as equally as possible
     2. Treat the checksum as a {0, 1} sequence but not an integer, and build a discrete distribution to estimate this checksum. This distribution is symmetric in the sense of Hamming distance, and decreases as it goes away from the center.



**Using Machine Learning Models**

Taking the analysis of UDP traffic as an example, the data set selects the camera to be connected to the router in a non-working state, the camera to the external computer side (using the PC software provided by the manufacturer), and the camera to the external mobile device (using the requirements in the user manual) APP) all UDP traffic generated. Different source IP addresses correspond to different working states of cameras, thus we use IP_src as the category label for machine learning classification. The learning goal is that when a new IP attempts to connect to the camera, the device can analyze the purpose of the new IP connection.

<img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20200806001759562.png" alt="image-20200806001759562" style="zoom: 50%;" />

Here you can see that the main source of data is the data generated by the connection with the PC software (58.101.161.102, this IP was found to be the HuaShu server in China) and the data generated by the connection with the mobile application (192.168.1.7, which is IP address of the phone). The remaining four-digit data comes from three Alibaba Cloud servers. A lot of the remaining small amount of data are found through IP address query comes from the local network in China, which should not be the normal traffic when we use the webcam.

* Data Preprocessing

  - Select 'ip_len', 'ip_ttl', 'udp_len' and bitwise disassembly 'ip_chksum', 'udp_chksum' as 35 features. Later, we can also try to extract features from the time series, and whether it is in the same network segment as the camera as a feature.
  -  Min-max normalization
  -  Dataset split for cross validation

- Random Forest

  - Acc: 0.9993361656930431

  - Importance:

    <img src="C:\Users\DELL\AppData\Roaming\Typora\typora-user-images\image-20200806003850688.png" alt="image-20200806003850688" style="zoom:50%;" />

    

    **As the importance of ip_ttl is so important, more than 0.7, I wonder whether our classification can still represent the different ways of using cameras instead of the network conditions of the corresponding equipment. This is a fatal problem.** 

    But the classification of equipment does work well with high accuracy.

- SVM
  - Acc: 0.988338644007789

- Naive Bayes
  - Acc: 0.9006461320587714

- The sequential model based on the softmax multi-classification of the multilayer perceptron:
  - Acc: 0.9960



In the future, the trained model will be used for the data of multiple webcam mobile applications to see if it can be classified well.

**But what if we find that different clients still use the camera in the same way and there are still big differences? It is unrealistic for the camera to remember how all clients work. This is confusing.**